name: Release

on:
  push:
    tags:
      - 'v*'

permissions:
  contents: write

jobs:
  build:
    name: Build Artifacts (${{ matrix.os }} / ${{ matrix.arch }})
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: ubuntu-latest
            arch: x64
          - os: macos-latest
            arch: arm64
          - os: macos-latest
            arch: x64
          - os: windows-latest
            arch: x64
    runs-on: ${{ matrix.os }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Get version
        id: get_version
        run: echo "VERSION=${GITHUB_REF#refs/tags/}" >> $GITHUB_OUTPUT

      - name: Build (electron-forge make)
        run: npm run build && npx electron-forge make --arch=${{ matrix.arch }}

      - name: Collect artifacts
        shell: bash
        run: |
          mkdir -p dist
          # Copy all generated files from out/make (electron-forge output) into dist
          if [ -d out/make ]; then
            find out/make -type f -maxdepth 4 -print -exec cp {} dist/ \;
          fi
          ls -lh dist || true

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: artifacts-${{ matrix.os }}-${{ matrix.arch }}
          path: dist/*
          if-no-files-found: warn

  release:
    name: Create Release
    runs-on: ubuntu-latest
    needs: build
    steps:
      - name: Download artifacts (Ubuntu x64)
        uses: actions/download-artifact@v4
        with:
          name: artifacts-ubuntu-latest-x64
          path: collected

      - name: Download artifacts (macOS arm64)
        uses: actions/download-artifact@v4
        with:
          name: artifacts-macos-latest-arm64
          path: collected

      - name: Download artifacts (macOS x64)
        uses: actions/download-artifact@v4
        with:
          name: artifacts-macos-latest-x64
          path: collected

      - name: Download artifacts (Windows x64)
        uses: actions/download-artifact@v4
        with:
          name: artifacts-windows-latest-x64
          path: collected

      - name: List collected artifacts
        run: ls -Rlh collected || true

      - name: Generate checksums
        id: checksums
        run: |
          cd collected
          # Use shasum for macOS compatibility, but on Linux runner sha256sum exists; prefer portable approach
          for f in *; do
            if [ -f "$f" ]; then
              if command -v sha256sum >/dev/null 2>&1; then
                sha256sum "$f" >> checksums.txt
              else
                shasum -a 256 "$f" >> checksums.txt
              fi
            fi
          done
          sort -o checksums.txt checksums.txt
          echo "Generated checksums:" && cat checksums.txt

      - name: Get version
        id: get_version
        run: echo "VERSION=${GITHUB_REF#refs/tags/}" >> $GITHUB_OUTPUT

      - name: Generate release notes
        id: release_notes
        run: |
          VERSION="${{ steps.get_version.outputs.VERSION }}"
          cat > release_notes.md << EOF
          ## Dockyard ${VERSION}

          A local-first multi-app workspace powered by Electron.

          ### Download

          Choose the installer for your platform:

          #### macOS
          - **Apple Silicon (M1/M2/M3)**: [Dockyard-${VERSION#v}-arm64.dmg](https://github.com/MayR-Labs/dockyard-electron/releases/download/${VERSION}/Dockyard-${VERSION#v}-arm64.dmg)
          - **Intel (x64)**: [Dockyard-${VERSION#v}-x64.dmg](https://github.com/MayR-Labs/dockyard-electron/releases/download/${VERSION}/Dockyard-${VERSION#v}-x64.dmg)

          **Important**: After installation, remove macOS quarantine:
          \`\`\`bash
          curl -sSL https://raw.githubusercontent.com/MayR-Labs/dockyard-electron/main/scripts/mac-first-run.sh | bash
          \`\`\`

          #### Windows
          - **Installer**: [Dockyard-${VERSION#v}.Setup.exe](https://github.com/MayR-Labs/dockyard-electron/releases/download/${VERSION}/Dockyard-${VERSION#v}.Setup.exe)

          #### Linux
          - **Debian/Ubuntu**: [dockyard_${VERSION#v}_amd64.deb](https://github.com/MayR-Labs/dockyard-electron/releases/download/${VERSION}/dockyard_${VERSION#v}_amd64.deb)
            \`\`\`bash
            sudo dpkg -i dockyard_${VERSION#v}_amd64.deb
            # Fix dependencies if needed:
            sudo apt -f install
            \`\`\`
          - **Fedora/RHEL**: [dockyard-${VERSION#v}-1.x86_64.rpm](https://github.com/MayR-Labs/dockyard-electron/releases/download/${VERSION}/dockyard-${VERSION#v}-1.x86_64.rpm)
            \`\`\`bash
            sudo rpm -i dockyard-${VERSION#v}-1.x86_64.rpm
            \`\`\`

          ### Checksums
          Verify file integrity using SHA-256:
          \`\`\`bash
          # Linux
          sha256sum <downloaded-file>
          # macOS
          shasum -a 256 <downloaded-file>
          \`\`\`
          Compare with checksums below or in \`checksums.txt\`.

          ### What's Changed
          See the [CHANGELOG](https://github.com/MayR-Labs/dockyard-electron/blob/main/CHANGELOG.md) for detailed updates.

          ### Transparency & Privacy
          Dockyard is local-first with no telemetry. Review the source at any time.

          ### Artifact Checksums (SHA-256)
          \`\`\`text
          EOF
          # Append checksums inline for convenience
          cat collected/checksums.txt >> release_notes.md
          echo '```' >> release_notes.md
          cat release_notes.md

      - name: Attach checksums file
        run: cp collected/checksums.txt .

      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          files: |
            collected/*
            checksums.txt
          body_path: release_notes.md
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
